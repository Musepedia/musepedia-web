<view 
  class="message-component">

  <scroll-view 
    class="dialog-area"  
    bindtap="closeAdditionalInput"
    refresher-enabled
    refresher-triggered="{{isRefreshing}}"
    refresher-default-style="none"
    bindrefresherrefresh="onRefresh" 
    scroll-into-view="{{bottomAnchor}}"
    scroll-y>
    <view slot="refresher" class="loading-section"><van-loading color="var(--primary-theme-color)"/></view>

    <message-dialog 
      wx:for="{{messages}}" 
      wx:for-item="message" 
      wx:key="unique"
      id="message-{{index}}" 
      right="{{message.right}}"
      avatar="{{message.avatar}}">
      <template is="{{messageComponent[message.type]}}" data="{{...message}}"></template>
    </message-dialog>

    <view style="height: 6px" id="bottom-anchor"></view>
  </scroll-view>

  <view 
    class="input-area" 
    style="bottom: {{showAdditionalInput ? 0 : keyboardHeight}}px; padding-bottom: {{keyboardHeight ? '10px' : 'env(safe-area-inset-bottom)'}}">
    <view class="input-wrapper">
      <view class="basic-input">
        <textarea 
          class="input-message" 
          adjust-position="{{false}}"
          value="{{message}}"
          bindfocus="onFocus"
          placeholder-style="font-size: 10px;"
          confirm-hold="{{false}}"
          disable-default-padding
          fixed
          auto-height 
          hold-keyboard="{{false}}"
          bindinput="onMessageInput"
          bindconfirm="sendMessage"
          confirm-type="send"
          show-confirm-bar="{{false}}">
          <view class="input-cencel">
            <van-icon class="scan-btn" name="scan" size="18px" bindtap="scanCode"></van-icon>
            <van-icon wx:if="{{message}}" name="clear" size="16px" bindtap="clearText"></van-icon>
          </view>
        </textarea>
        
        <button class="button-send {{message ? 'expand' : ''}}" bindtap="sendMessage">发送</button>
      </view>

    </view>
    <view class="float-input" wx:if="{{false}}">
      <text class="hint-question-btn" wx:for="{{['RECOMM','大熊猫','小熊猫','中熊猫分布']}}" wx:key="unique">{{item}}</text>
      <van-icon name="clear" size="16px" bindtap="clearText"></van-icon>
    </view>
  </view>
</view>



<!-- 普通消息框(纯文字)，主要为发送消息 -->
<template name="common-message">
  <common-message 
      right="{{right}}" 
      show-arrow="{{showArrow}}"
      full-width="{{fullWidth}}" 
      transparent="{{transparent}}"
      text-center="{{textCenter}}">
      <text style="display:inline-block;padding:8px 12px;">{{text}}</text>
  </common-message>
</template>

<!-- 弹出回答详细信息 -->
<van-popup
  class="popup-enable-overflow"
  show="{{showQuestionCard}}"
  custom-style="width: 80%;"
  round
  bind:close="closePopup">
  <question-card
    question="{{popupQuestion.question}}"
    answer="{{popupQuestion.answer}}"
    src="{{popupQuestion.src}}"
    show-action-bar>
    <view wx:if="{{popupQuestion.recommendQuestions}}" style="padding:var(--padding-horizontal)">
      <view>推荐问题：</view>
      <view class="question-recommend__text" wx:for="{{popupQuestion.recommendQuestions}}" wx:key="unique">
        {{item}}
      </view>
    </view>  
  </question-card>
</van-popup>

<!-- 图片回复-->
<template name="reply-img-message">
  <common-message 
      class="message-reply with-image"
      right="{{right}}" 
      show-arrow="{{showArrow}}"
      show-more="{{data.isReply && data.status}}"
      full-width
      transparent="{{transparent}}"
      data-data="{{data}}"
      bindmoretap="showQuestionCardPopup">
    <image style="width:100%;border-radius:12px;" src="{{data.answer}}" mode="widthFix"></image>
  </common-message>
</template>

<!-- 文字回复 -->
<template name="common-message-recommend">
  <common-message 
      class="message-reply'"
      right="{{false}}" 
      show-arrow="{{showArrow}}"
      show-more
      full-width="{{fullWidth}}" 
      transparent="{{transparent}}"
      text-center="{{textCenter}}"
      data-data="{{data}}"
      bindmoretap="showQuestionCardPopup">
    <text style="display:inline-block;padding:8px 20px 8px 12px;width:100%;">{{text}}</text>
  </common-message>
</template>

<template name="hall-message">
  <common-message 
      class="message-reply with-image"
      right="{{right}}" 
      show-arrow="{{showArrow}}"
      full-width
      data-data="{{data}}">
    <image style="width:100%;border-radius:12px;position:relative;" src="{{data.src}}" mode="widthFix">
      <modal opacity=".5"></modal>
      <view class="absolute-wrapper">{{data.text}}</view>
    </image>
  </common-message>
</template>

<!-- 时间信息等提示信息 -->
<template name="hint-message">
  <view class="hint-message {{divider ? 'with-divider' : ''}}">
    <text>{{text}}</text>
  </view>
</template>
